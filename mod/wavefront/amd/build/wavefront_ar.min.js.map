{"version":3,"file":"wavefront_ar.min.js","sources":["../src/wavefront_ar.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Encapsules the behavior for creating a Wavefront 3D model in Moodle.\n *\n * Manages the UI while operations are occuring, including rendering and manipulating the model.\n *\n * @module     mod_wavefront/wavefront_ar\n * @class      wavefront_ar\n * @package    mod_wavefront\n * @copyright  2022 Ian Wild\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport * as THREE from 'mod_wavefront/three';\nimport { MTLLoader } from 'mod_wavefront/MTLLoader';\nimport { OBJLoader } from 'mod_wavefront/OBJLoader';\nimport { ARButton } from 'mod_wavefront/ARButton';\nimport jQuery from 'jquery';\n\nlet camera, scene, renderer;\nlet controller;\n\nlet reticle;\nlet object;\nlet objectscale;\n\nlet hitTestSource = null;\nlet hitTestSourceRequested = false;\n\n\nexport const init = (stage, scale) => {\n\n\tvar container = document.getElementById(stage);\n    console.log(container);\n    \n    // Object vector scaling\n    objectscale = scale;\n    \n    // Get model files\n\tvar mtl = jQuery(container).attr(\"data-mtl\");\n\tconsole.log(mtl);\n\tvar mtl_file = decodeURIComponent(mtl);\n\tconsole.log(mtl_file);\n\tvar obj = jQuery(container).attr(\"data-obj\");\n\tconsole.log(obj);\n\tvar obj_file = decodeURIComponent(obj);\n\tconsole.log(obj_file);\n\t\n\t// Get camera attributes\n\tvar cameraangle = jQuery(container).attr(\"data-cameraangle\");\n    console.log(cameraangle);\n    var cameranear = jQuery(container).attr(\"data-cameranear\");\n\tconsole.log(cameranear);\n\tvar camerafar = jQuery(container).attr(\"data-camerafar\");\n\tconsole.log(camerafar);\n\tvar camerax = jQuery(container).attr(\"data-camerax\");\n\tconsole.log(camerax);\n\tvar cameray = jQuery(container).attr(\"data-cameray\");\n\tconsole.log(cameray);\n\tvar cameraz = jQuery(container).attr(\"data-cameraz\");\n\tconsole.log(cameraz);\n\n\tscene = new THREE.Scene();\n\n\tvar VIEW_ANGLE = Number(cameraangle), ASPECT = window.innerWidth / window.innerHeight, NEAR = Number(cameranear), FAR = Number(camerafar);\n\tcamera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);\n\tcamera.position.set(Number(camerax),Number(cameray),Number(cameraz));\t\n\n\t// Lighting\n\tvar keyLight = new THREE.DirectionalLight(new THREE.Color('hsl(30, 100%, 75%)'), 1.0);\n\tkeyLight.position.set(-100, 0, 100);\n\t\t\t\n\tvar fillLight = new THREE.DirectionalLight(new THREE.Color('hsl(240, 100%, 75%)'), 0.75);\n\tfillLight.position.set(100, 0, 100);\n\t\t\t\n\tvar backLight = new THREE.DirectionalLight(0xffffff, 1.0);\n\tbackLight.position.set(100, 0, -100).normalize();\n\n\tscene.add(keyLight);\n\tscene.add(fillLight);\n\tscene.add(backLight);\n\t\n\t//\n\n\trenderer = new THREE.WebGLRenderer( { antialias: true, alpha: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.xr.enabled = true;\n\trenderer.xr.setReferenceSpaceType( 'local' );\n\tcontainer.appendChild( renderer.domElement );\n\n    //\n    \n    renderer.xr.addEventListener('sessionend', function ( event ) {\n    \tscene.remove( object );\n\t\tscene.add( reticle );\n\t\treticle.visible = false;\n\t\tcontroller.addEventListener( 'select', onSelect );\n\t});\n    \n\t//\n\n\tdocument.body.appendChild( ARButton.createButton( renderer, { requiredFeatures: [ 'hit-test' ] } ) );\n\n\t//\n\n\tfunction onSelect() {\n\n\t\tif ( reticle.visible ) {\n\n\t\t\t/* Load model */\n\t\t\tvar mtlLoader = new MTLLoader();\n\t\t    mtlLoader.load(mtl_file, (materials) => {\n\t\t\n\t\t        materials.preload();\n\t\t\n\t\t        var objLoader = new OBJLoader();\n\t\t        objLoader.setMaterials(materials);\n\t\t        objLoader.load(obj_file, function (obj) {\n\t\t            object = obj;\n\t\t        \treticle.matrix.decompose( object.position,  object.quaternion, object.scale );\n\t\t        \tobject.scale.set(objectscale,objectscale,objectscale);\n\t\t\t\t\tscene.add( object );\n\t\t\t\t\tcontroller.removeEventListener( 'select', onSelect );\n\t\t\t\t\tscene.remove(reticle);\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\tcontroller = renderer.xr.getController( 0 );\n\tcontroller.addEventListener( 'select', onSelect );\n\tscene.add( controller );\n\n\treticle = new THREE.Mesh(\n\t\tnew THREE.RingGeometry( 0.15, 0.2, 32 ).rotateX( - Math.PI / 2 ),\n\t\tnew THREE.MeshBasicMaterial()\n\t);\n\treticle.matrixAutoUpdate = false;\n\treticle.visible = false;\n\tscene.add( reticle );\n\n\t//\n\n\twindow.addEventListener( 'resize', onWindowResize );\n\n    animate();\n}\n\nfunction onWindowResize() {\n\n\tcamera.aspect = window.innerWidth / window.innerHeight;\n\tcamera.updateProjectionMatrix();\n\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\n}\n\n//\n\nfunction animate() {\n\n\trenderer.setAnimationLoop( render );\n\n}\n\nfunction render( timestamp, frame ) {\n\n\tif ( frame ) {\n\n\t\tconst referenceSpace = renderer.xr.getReferenceSpace();\n\t\tconst session = renderer.xr.getSession();\n\n\t\tif ( hitTestSourceRequested === false ) {\n\n\t\t\tsession.requestReferenceSpace( 'viewer' ).then( function ( referenceSpace ) {\n\n\t\t\t\tsession.requestHitTestSource( { space: referenceSpace } ).then( function ( source ) {\n\n\t\t\t\t\thitTestSource = source;\n\n\t\t\t\t} );\n\n\t\t\t} );\n\n\t\t\tsession.addEventListener( 'end', function () {\n\n\t\t\t\thitTestSourceRequested = false;\n\t\t\t\thitTestSource = null;\n\n\t\t\t} );\n\n\t\t\thitTestSourceRequested = true;\n\n\t\t}\n\n\t\tif ( hitTestSource ) {\n\n\t\t\tconst hitTestResults = frame.getHitTestResults( hitTestSource );\n\n\t\t\tif ( hitTestResults.length ) {\n\n\t\t\t\tconst hit = hitTestResults[ 0 ];\n\n\t\t\t\treticle.visible = true;\n\t\t\t\treticle.matrix.fromArray( hit.getPose( referenceSpace ).transform.matrix );\n\n\t\t\t} else {\n\n\t\t\t\treticle.visible = false;\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\trenderer.render( scene, camera );\n\n}"],"names":["camera","scene","renderer","controller","reticle","object","objectscale","hitTestSource","hitTestSourceRequested","onWindowResize","aspect","window","innerWidth","innerHeight","updateProjectionMatrix","setSize","render","timestamp","frame","referenceSpace","xr","getReferenceSpace","session","getSession","requestReferenceSpace","then","requestHitTestSource","space","source","addEventListener","hitTestResults","getHitTestResults","length","hit","visible","matrix","fromArray","getPose","transform","stage","scale","container","document","getElementById","console","log","mtl","attr","mtl_file","decodeURIComponent","obj","obj_file","cameraangle","cameranear","camerafar","camerax","cameray","cameraz","THREE","Scene","VIEW_ANGLE","Number","ASPECT","NEAR","FAR","PerspectiveCamera","position","set","keyLight","DirectionalLight","Color","fillLight","backLight","onSelect","MTLLoader","load","materials","preload","objLoader","OBJLoader","setMaterials","decompose","quaternion","add","removeEventListener","remove","normalize","WebGLRenderer","antialias","alpha","setPixelRatio","devicePixelRatio","enabled","setReferenceSpaceType","appendChild","domElement","event","body","ARButton","createButton","requiredFeatures","getController","Mesh","RingGeometry","rotateX","Math","PI","MeshBasicMaterial","matrixAutoUpdate","setAnimationLoop"],"mappings":"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"}