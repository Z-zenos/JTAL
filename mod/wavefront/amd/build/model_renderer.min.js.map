{"version":3,"sources":["../src/model_renderer.js"],"names":["cameras","controls_array","scenes","renderers","containers","stage_widths","stage_heights","scene_backcolours","ambients","keyLights","fillLights","backLights","windowHalfX","window","innerWidth","windowHalfY","innerHeight","animate","forEach","renderer","i","render","update","requestAnimationFrame","init","stages","WebGL","isWebGLAvailable","warning","getWebGLErrorMessage","document","getElementById","appendChild","console","log","stage","container","push","stage_width","attr","stage_height","backcol","cameraangle","camerafar","camerax","cameray","cameraz","mtl","mtl_file","decodeURIComponent","obj","obj_file","mtlLoader","MTLLoader","load","materials","preload","objLoader","OBJLoader","setMaterials","object","scene","THREE","Scene","camera","PerspectiveCamera","add","position","set","ambient","AmbientLight","keyLight","DirectionalLight","Color","fillLight","backLight","normalize","background","WebGLRenderer","setPixelRatio","devicePixelRatio","setSize","setClearColor","domElement","controls","OrbitControls","enableDamping","dampingFactor","addEventListener","e","stopPropagation","code","lighting","intensity","remove","next"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Encapsules the behavior for creating a Wavefront 3D model in Moodle.\n *\n * Manages the UI while operations are occuring, including rendering and manipulating the model.\n *\n * @module     mod_wavefront/model_renderer\n * @class      model_renderer\n * @package    mod_wavefront\n * @copyright  2022 Ian Wild\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport WebGL from 'mod_wavefront/WebGL';\nimport * as THREE from 'mod_wavefront/three';\nimport { MTLLoader } from 'mod_wavefront/MTLLoader';\nimport { OBJLoader } from 'mod_wavefront/OBJLoader';\nimport { OrbitControls } from 'mod_wavefront/OrbitControls';\nimport jQuery from 'jquery';\n\nvar cameras = [], controls_array = [], scenes = [], renderers = [];\n\nvar containers = [];\nvar stage_widths = [], stage_heights = [], scene_backcolours = []; \nvar lightings = [], ambients = [], keyLights = [], fillLights = [], backLights = [];\n\nvar windowHalfX = window.innerWidth / 2;\nvar windowHalfY = window.innerHeight / 2;\n\nconst animate = () => {\n\t renderers.forEach( function(renderer, i) {\n\t    renderer.render(scenes[i], cameras[i]);\n\t \tcontrols_array[i].update();\n\t });\n\t \n\t requestAnimationFrame(animate);\n}\n\nexport const init = (stages) => {\n\n\tif (!WebGL.isWebGLAvailable() ) {\t\t\t\n\t    const warning = WebGL.getWebGLErrorMessage();\n\t\tdocument.getElementById( 'container' ).appendChild( warning );\n\t    return true;\n\t}\n\t\n\tconsole.log(stages);\n\t\n    stages.forEach(function(stage) {\n        \n    \tvar container = document.getElementById(stage);\n    \tconsole.log(container);\n\t\tcontainers.push(container);\n\t\t\n\t\t// Get stage attributes\n\t\tvar stage_width = jQuery(container).attr(\"data-stagewidth\");\n\t\tconsole.log(stage_width);\n\t\tstage_widths.push(stage_width);\n\t\tvar stage_height = jQuery(container).attr(\"data-stageheight\");\n\t\tconsole.log(stage_height);\n\t    stage_heights.push(stage_height);\n\t    var backcol = jQuery(container).attr(\"data-backcol\");\n\t\tconsole.log(backcol);\n\t    scene_backcolours.push(backcol);\n\t    \n\t\t// Get camera attributes\n\t\tvar cameraangle = jQuery(container).attr(\"data-cameraangle\");\n\t    console.log(cameraangle);\n\t\tvar camerafar = jQuery(container).attr(\"data-camerafar\");\n\t\tconsole.log(camerafar);\n\t\tvar camerax = jQuery(container).attr(\"data-camerax\");\n\t\tconsole.log(camerax);\n\t\tvar cameray = jQuery(container).attr(\"data-cameray\");\n\t\tconsole.log(cameray);\n\t\tvar cameraz = jQuery(container).attr(\"data-cameraz\");\n\t\tconsole.log(cameraz);\n\t\t\n\t\t// Get model files\n\t\tvar mtl = jQuery(container).attr(\"data-mtl\");\n\t\tconsole.log(mtl);\n\t\tvar mtl_file = decodeURIComponent(mtl);\n\t\tconsole.log(mtl_file);\n\t\tvar obj = jQuery(container).attr(\"data-obj\");\n\t\tconsole.log(obj);\n\t\tvar obj_file = decodeURIComponent(obj);\n\t\tconsole.log(obj_file);\n\t\t\n\t\t/* Load model */\n\t\tvar mtlLoader = new MTLLoader();\n\t    mtlLoader.load(mtl_file, (materials) => {\n\t\n\t        materials.preload();\n\t\n\t        var objLoader = new OBJLoader();\n\t        objLoader.setMaterials(materials);\n\t        objLoader.load(obj_file, function (object) {\n\t        \n\t        \t// Create scene\n\t\t\t\tvar scene = new THREE.Scene();\n\t\t\t\tscenes.push(scene);\n\t\t\t\t\n\t\t\t\t// Camera\n\t\t\t\tvar SCREEN_WIDTH = stage_width, SCREEN_HEIGHT = stage_height;\n\t\t\t\tvar VIEW_ANGLE = Number(cameraangle), ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = Number(camerafar);\n\t\t\t\tvar camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);\n\t\t\t\tcameras.push(camera);\n\t\t\t\tscene.add(camera);\n\t\t\t\tcamera.position.set(Number(camerax),Number(cameray),Number(cameraz));\t\n\t\t\t\n\t\t\t\tvar ambient = new THREE.AmbientLight(0xffffff, 1.0);\n\t\t\t\tambients.push(ambient);\t\n\t\t\t\tscene.add(ambient);\n\t\t\t\t// Lighting\n\t\t\t\tvar keyLight = new THREE.DirectionalLight(new THREE.Color('hsl(30, 100%, 75%)'), 1.0);\n\t\t\t\tkeyLights.push(keyLight);\n\t\t\t\tkeyLight.position.set(-100, 0, 100);\n\t\t\t\n\t\t\t\tvar fillLight = new THREE.DirectionalLight(new THREE.Color('hsl(240, 100%, 75%)'), 0.75);\n\t\t\t\tfillLights.push(fillLight);\n\t\t\t\tfillLight.position.set(100, 0, 100);\n\t\t\t\n\t\t\t\tvar backLight = new THREE.DirectionalLight(0xffffff, 1.0);\n\t\t\t\tbackLights.push(backLight);\n\t\t\t\tbackLight.position.set(100, 0, -100).normalize();\n\t\t\t\n\t\t\t\tscene.add(keyLight);\n\t\t\t\tscene.add(fillLight);\n\t\t\t\tscene.add(backLight);\n\t            scene.add(object);\n\t            var iCol = Number(\"0x\" + backcol); \n\t            scene.background = new THREE.Color(iCol);\n\t\n\t\t\t\t/* Renderer */\n\t    \n\t\t\t    var renderer = new THREE.WebGLRenderer();\n\t\t\t    renderer.setPixelRatio(window.devicePixelRatio);\n\t\t\t    renderer.setSize(stage_width, stage_height);\n\t\t\t    renderer.setClearColor(new THREE.Color(\"hsl(0, 0%, 10%)\"));\n\t\t\t    renderers.push(renderer);\n\t\t\t    container.appendChild(renderer.domElement);\n\t\t\t                \n\t            /* Controls */\n\t\n\t\t\t    var controls = new OrbitControls(camera, renderer.domElement);\n\t\t\t    controls.enableDamping = true;\n\t\t\t    controls.dampingFactor = 0.25;\n\t\t\t    controls_array.push(controls);\n\t\t\t     \n\t\t\t    /* Events */\n\t\t\t  \n\t\t\t    window.addEventListener('keydown', function (e) {\n\t\t\t    \te.stopPropagation();\n\t\t\t    \tif (e.code === 'KeyL') {\n\t\t\t            lighting = !lighting;\n\t\t\t            if (lighting) {\n\t\t\t                ambient.intensity = 0.25;\n\t\t\t                scene.add(keyLight);\n\t\t\t                scene.add(fillLight);\n\t\t\t                scene.add(backLight);\n\t\t\t            } else {\n\t\t\t                ambient.intensity = 1.0;\n\t\t\t                scene.remove(keyLight);\n\t\t\t                scene.remove(fillLight);\n\t\t\t                scene.remove(backLight);\n\t\t\t            }\n\t\t\t        }\t\n\t\t\t    }, false);\n\t\t\t    \n\t\t\t    /* Remove the loading spinner */\n\t\t\t    jQuery(container).next().remove();\n\t\t\t\n\t\t\t    /* Start animation */\n\t\t\t\tanimate();\n\t            \n\t        });\n\t    }); \n\t});\n};"],"file":"model_renderer.min.js"}