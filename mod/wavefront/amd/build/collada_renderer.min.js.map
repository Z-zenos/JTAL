{"version":3,"file":"collada_renderer.min.js","sources":["../src/collada_renderer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Encapsules the behavior for creating a Collada 3D model in Moodle.\n *\n * Manages the UI while operations are occuring, including rendering and manipulating the model.\n *\n * @module     mod_wavefront/collada_renderer\n * @class      collada_renderer\n * @package    mod_wavefront\n * @copyright  2022 Ian Wild\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport WebGL from 'mod_wavefront/WebGL';\nimport * as THREE from 'mod_wavefront/three';\nimport { ColladaLoader } from 'mod_wavefront/ColladaLoader';\nimport { OrbitControls } from 'mod_wavefront/OrbitControls';\n\nimport jQuery from 'jquery';\n\nvar cameras = [], controls_array = [], scenes = [], renderers = [];\n\nvar containers = [];\n \nvar stage_widths = [], stage_heights = [], scene_backcolours = []; \nvar ambients = [], pointlights = [];\nvar clocks = [], mixers = [];\n\nconst animate = () => {\n\t\n\trenderers.forEach( function(renderer, i) {\n\n\t\tif ( mixers[i] !== undefined ) {\n\t\t\tvar delta = clocks[i].getDelta();\n\t\t\tmixers[i].update( delta );\n\t\t\trenderer.render(scenes[i], cameras[i]);\n\t \t\tcontrols_array[i].update();\n\t\t}\n\t});\n\t\n\trequestAnimationFrame( animate );\n}\n\nexport const init = (stage) => {\n\n\tif (!WebGL.isWebGLAvailable() ) {\t\t\t\n\t    const warning = WebGL.getWebGLErrorMessage();\n\t\tdocument.getElementById( 'container' ).appendChild( warning );\n\t    return true;\n\t}\n\t\n\tconsole.log(stage);\n    \n\tvar container = document.getElementById(stage);\n\tconsole.log(container);\n\tcontainers.push(container);\n\t\n\t// Get stage attributes\n\tvar stage_width = jQuery(container).attr(\"data-stagewidth\");\n\tconsole.log('stage width: ' + stage_width);\n\tstage_widths.push(stage_width);\n\tvar stage_height = jQuery(container).attr(\"data-stageheight\");\n\tconsole.log('stage height: ' + stage_height);\n    stage_heights.push(stage_height);\n    var backcol = jQuery(container).attr(\"data-backcol\");\n\tconsole.log('background  color: ' + backcol);\n    scene_backcolours.push(backcol);\n    \n\t// Get camera attributes\n\tvar cameraangle = jQuery(container).attr(\"data-cameraangle\");\n    console.log('camera angle: ' + cameraangle);\n    var cameranear = jQuery(container).attr(\"data-cameranear\");\n\tconsole.log('camera near: ' + cameranear);\n\tvar camerafar = jQuery(container).attr(\"data-camerafar\");\n\tconsole.log('camera far: ' + camerafar);\n\tvar camerax = jQuery(container).attr(\"data-camerax\");\n\tconsole.log('camera x: ' + camerax);\n\tvar cameray = jQuery(container).attr(\"data-cameray\");\n\tconsole.log('camera y: ' + cameray);\n\tvar cameraz = jQuery(container).attr(\"data-cameraz\");\n\tconsole.log('camera z: ' + cameraz);\n\t\n\t// Get controls attributes\n\tvar controlx = jQuery(container).attr(\"data-controlx\");\n\tconsole.log('control x: ' + controlx);\n\tvar controly = jQuery(container).attr(\"data-controly\");\n\tconsole.log('control y: ' + controly);\n\tvar controlz = jQuery(container).attr(\"data-controlz\");\n\tconsole.log('control z: ' + controlz);\n\t\n\t// Get model files\n\tvar baseurl = jQuery(container).attr(\"data-baseurl\");\n\tvar base_url = decodeURIComponent(baseurl);\n\tconsole.log(base_url);\n\t\n\tvar dae = jQuery(container).attr(\"data-dae\");\n\tvar dae_file = decodeURIComponent(dae);\n\tconsole.log(dae_file);\n\t\n\t/* Load model */\n\tvar daeLoader = new ColladaLoader();\n    daeLoader.load(dae_file, (collada) => {\n\n\t\tvar animations = collada.animations;\n\t\tvar avatar = collada.scene;\n\n\t\tavatar.traverse( function ( node ) {\n\n\t\t\tif ( node.isSkinnedMesh ) {\n\n\t\t\t\tnode.frustumCulled = false;\n\n\t\t\t}\n\n\t\t} );\n\t\t\n\t\t// Create scene\n\t\tvar scene = new THREE.Scene();\n\t\tscenes.push(scene);\n\t\t\n\t\t// Camera\n\t\tvar SCREEN_WIDTH = stage_width, SCREEN_HEIGHT = stage_height;\n\t\tvar VIEW_ANGLE = Number(cameraangle), ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = Number(cameranear), FAR = Number(camerafar);\n\t\tvar camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);\n\t\tcameras.push(camera);\n\t\tscene.add(camera);\n\t\tcamera.position.set(Number(camerax),Number(cameray),Number(cameraz));\t\n\t\n\t\tclock = new THREE.Clock();\n\t\tclocks.push(clock);\n\n\t\tmixer = new THREE.AnimationMixer( avatar );\n\t\tmixers.push(mixer);\n\t\t\n\t\tvar action = mixer.clipAction( animations[ 0 ] ).play();\n\n\t\tscene.add( avatar );\n\t\tvar iCol = Number(\"0x\" + backcol); \n        scene.background = new THREE.Color(iCol);\n\t\t\n\t\tvar ambientLight = new THREE.AmbientLight( 0xffffff, 0.2 );\n\t\tambients.push[ambientLight];\n\t\tscene.add( ambientLight );\n\n\t\tvar pointLight = new THREE.PointLight( 0xffffff, 0.8 );\n\t\tpointlights.push[pointLight];\n\t\t\n\t\tscene.add( camera );\n\t\tcamera.add( pointLight );\n\n\t\t/* Renderer */\n\n\t\tvar renderer = new THREE.WebGLRenderer( { antialias: true } );\n\t\trenderer.setPixelRatio(window.devicePixelRatio);\n\t\trenderer.setSize(stage_width, stage_height);\n\t\trenderer.setClearColor(new THREE.Color(\"hsl(0, 0%, 10%)\"));\n\t\trenderers.push(renderer);\n\t\tcontainer.appendChild(renderer.domElement);\n\n\t\t/* Controls */\n\n\t\tvar controls = new OrbitControls( camera, renderer.domElement );\n\t\tcontrols.enableDamping = true;\n\t\tcontrols.dampingFactor = 0.25;\n\t\tcontrols.target.set(Number(controlx), Number(controly), Number(controlz));\n\t\tcontrols_array.push(controls);\n\t\t\n\t\t/* Remove the loading spinner */\n\t\tjQuery(container).next().remove();\n\t\t\t\n\t    /* Start animation */\n\t\tanimate();\n        \n    }); \n};"],"names":["cameras","controls_array","scenes","renderers","containers","stage_widths","stage_heights","scene_backcolours","ambients","pointlights","clocks","mixers","animate","forEach","renderer","i","undefined","delta","getDelta","update","render","requestAnimationFrame","stage","WebGL","isWebGLAvailable","warning","getWebGLErrorMessage","document","getElementById","appendChild","console","log","container","push","stage_width","attr","stage_height","backcol","cameraangle","cameranear","camerafar","camerax","cameray","cameraz","controlx","controly","controlz","baseurl","base_url","decodeURIComponent","dae","dae_file","ColladaLoader","load","collada","animations","avatar","scene","traverse","node","isSkinnedMesh","frustumCulled","THREE","Scene","SCREEN_WIDTH","SCREEN_HEIGHT","VIEW_ANGLE","Number","ASPECT","NEAR","FAR","camera","PerspectiveCamera","add","position","set","clock","Clock","mixer","AnimationMixer","clipAction","play","iCol","background","Color","ambientLight","AmbientLight","pointLight","PointLight","WebGLRenderer","antialias","setPixelRatio","window","devicePixelRatio","setSize","setClearColor","domElement","controls","OrbitControls","enableDamping","dampingFactor","target","next","remove"],"mappings":"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"}