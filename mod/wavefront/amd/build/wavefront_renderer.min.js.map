{"version":3,"file":"wavefront_renderer.min.js","sources":["../src/wavefront_renderer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Encapsules the behavior for creating a Wavefront 3D model in Moodle.\n *\n * Manages the UI while operations are occuring, including rendering and manipulating the model.\n *\n * @module     mod_wavefront/model_renderer\n * @class      model_renderer\n * @package    mod_wavefront\n * @copyright  2022 Ian Wild\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport WebGL from 'mod_wavefront/WebGL';\nimport * as THREE from 'mod_wavefront/three';\nimport { MTLLoader } from 'mod_wavefront/MTLLoader';\nimport { OBJLoader } from 'mod_wavefront/OBJLoader';\nimport { OrbitControls } from 'mod_wavefront/OrbitControls';\nimport jQuery from 'jquery';\n\nvar cameras = [], controls_array = [], scenes = [], renderers = [];\n\nvar containers = [];\nvar stage_widths = [], stage_heights = [], scene_backcolours = []; \nvar lightings = [], ambients = [], keyLights = [], fillLights = [], backLights = [];\n\nvar windowHalfX = window.innerWidth / 2;\nvar windowHalfY = window.innerHeight / 2;\n\nconst animate = () => {\n\t renderers.forEach( function(renderer, i) {\n\t    renderer.render(scenes[i], cameras[i]);\n\t \tcontrols_array[i].update();\n\t });\n\t \n\t requestAnimationFrame(animate);\n}\n\nexport const init = (stage) => {\n\n\tif (!WebGL.isWebGLAvailable() ) {\t\t\t\n\t    const warning = WebGL.getWebGLErrorMessage();\n\t\tdocument.getElementById( 'container' ).appendChild( warning );\n\t    return true;\n\t}\n\t\n\tconsole.log(stage);\n    \n\tvar container = document.getElementById(stage);\n\tconsole.log(container);\n\tcontainers.push(container);\n\t\n\t// Get stage attributes\n\tvar stage_width = jQuery(container).attr(\"data-stagewidth\");\n\tconsole.log('stage width: ' + stage_width);\n\tstage_widths.push(stage_width);\n\tvar stage_height = jQuery(container).attr(\"data-stageheight\");\n\tconsole.log('stage height: ' + stage_height);\n    stage_heights.push(stage_height);\n    var backcol = jQuery(container).attr(\"data-backcol\");\n\tconsole.log('background color: ' + backcol);\n    scene_backcolours.push(backcol);\n    \n\t// Get camera attributes\n\tvar cameraangle = jQuery(container).attr(\"data-cameraangle\");\n    console.log('camera angle: ' + cameraangle);\n\tvar cameranear = jQuery(container).attr(\"data-cameranear\");\n\tconsole.log('camera near: ' + cameranear);\n\tvar camerafar = jQuery(container).attr(\"data-camerafar\");\n\tconsole.log('camera far: ' + cameranear);\n\tvar camerax = jQuery(container).attr(\"data-camerax\");\n\tconsole.log('camera x: ' + camerax);\n\tvar cameray = jQuery(container).attr(\"data-cameray\");\n\tconsole.log('camera y: ' + cameray);\n\tvar cameraz = jQuery(container).attr(\"data-cameraz\");\n\tconsole.log('camera z: ' + cameraz);\n\t\n\t// Get controls attributes\n\tvar controlx = jQuery(container).attr(\"data-controlx\");\n\tconsole.log('control x: ' + controlx);\n\tvar controly = jQuery(container).attr(\"data-controly\");\n\tconsole.log('control y: ' + controly);\n\tvar controlz = jQuery(container).attr(\"data-controlz\");\n\tconsole.log('control z: ' + controlz);\n\t\n\t// Get model files\n\tvar mtl = jQuery(container).attr(\"data-mtl\");\n\tconsole.log(mtl);\n\tvar mtl_file = decodeURIComponent(mtl);\n\tconsole.log(mtl_file);\n\tvar obj = jQuery(container).attr(\"data-obj\");\n\tconsole.log(obj);\n\tvar obj_file = decodeURIComponent(obj);\n\tconsole.log(obj_file);\n\t\n\t/* Load model */\n\tvar mtlLoader = new MTLLoader();\n    mtlLoader.load(mtl_file, (materials) => {\n\n        materials.preload();\n\n        var objLoader = new OBJLoader();\n        objLoader.setMaterials(materials);\n        objLoader.load(obj_file, function (object) {\n        \n        \t// Create scene\n\t\t\tvar scene = new THREE.Scene();\n\t\t\tscenes.push(scene);\n\t\t\t\n\t\t\t// Camera\n\t\t\tvar SCREEN_WIDTH = stage_width, SCREEN_HEIGHT = stage_height;\n\t\t\tvar VIEW_ANGLE = Number(cameraangle), ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = Number(cameranear), FAR = Number(camerafar);\n\t\t\tvar camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);\n\t\t\tcameras.push(camera);\n\t\t\tscene.add(camera);\n\t\t\tcamera.position.set(Number(camerax),Number(cameray),Number(cameraz));\t\n\t\t\n\t\t\tvar ambient = new THREE.AmbientLight(0xffffff, 1.0);\n\t\t\tambients.push(ambient);\t\n\t\t\tscene.add(ambient);\n\t\t\t// Lighting\n\t\t\tvar keyLight = new THREE.DirectionalLight(new THREE.Color('hsl(30, 100%, 75%)'), 1.0);\n\t\t\tkeyLights.push(keyLight);\n\t\t\tkeyLight.position.set(-100, 0, 100);\n\t\t\n\t\t\tvar fillLight = new THREE.DirectionalLight(new THREE.Color('hsl(240, 100%, 75%)'), 0.75);\n\t\t\tfillLights.push(fillLight);\n\t\t\tfillLight.position.set(100, 0, 100);\n\t\t\n\t\t\tvar backLight = new THREE.DirectionalLight(0xffffff, 1.0);\n\t\t\tbackLights.push(backLight);\n\t\t\tbackLight.position.set(100, 0, -100).normalize();\n\t\t\n\t\t\tscene.add(keyLight);\n\t\t\tscene.add(fillLight);\n\t\t\tscene.add(backLight);\n            scene.add(object);\n            var iCol = Number(\"0x\" + backcol); \n            scene.background = new THREE.Color(iCol);\n\n\t\t\t/* Renderer */\n    \n\t\t    var renderer = new THREE.WebGLRenderer();\n\t\t    renderer.setPixelRatio(window.devicePixelRatio);\n\t\t    renderer.setSize(stage_width, stage_height);\n\t\t    renderer.setClearColor(new THREE.Color(\"hsl(0, 0%, 10%)\"));\n\t\t    renderers.push(renderer);\n\t\t    container.appendChild(renderer.domElement);\n\t\t                \n            /* Controls */\n\n\t\t    var controls = new OrbitControls(camera, renderer.domElement);\n\t\t    controls.enableDamping = true;\n\t\t    controls.dampingFactor = 0.25;\n\t\t    controls.target.set(Number(controlx), Number(controly), Number(controlz));\n\t\t    controls_array.push(controls);\n\t\t     \n\t\t    /* Events */\n\t\t  \n\t\t    window.addEventListener('keydown', function (e) {\n\t\t    \te.stopPropagation();\n\t\t    \tif (e.code === 'KeyL') {\n\t\t            lighting = !lighting;\n\t\t            if (lighting) {\n\t\t                ambient.intensity = 0.25;\n\t\t                scene.add(keyLight);\n\t\t                scene.add(fillLight);\n\t\t                scene.add(backLight);\n\t\t            } else {\n\t\t                ambient.intensity = 1.0;\n\t\t                scene.remove(keyLight);\n\t\t                scene.remove(fillLight);\n\t\t                scene.remove(backLight);\n\t\t            }\n\t\t        }\t\n\t\t    }, false);\n\t\t    \n\t\t    /* Remove the loading spinner */\n\t\t    jQuery(container).next().remove();\n\t\t\n\t\t    /* Start animation */\n\t\t\tanimate();\n            \n        });\n    }); \n};"],"names":["cameras","controls_array","scenes","renderers","containers","stage_widths","stage_heights","scene_backcolours","ambients","keyLights","fillLights","backLights","window","innerWidth","innerHeight","animate","forEach","renderer","i","render","update","requestAnimationFrame","stage","WebGL","isWebGLAvailable","warning","getWebGLErrorMessage","document","getElementById","appendChild","console","log","container","push","stage_width","attr","stage_height","backcol","cameraangle","cameranear","camerafar","camerax","cameray","cameraz","controlx","controly","controlz","mtl","mtl_file","decodeURIComponent","obj","obj_file","MTLLoader","load","materials","preload","objLoader","OBJLoader","setMaterials","object","scene","THREE","Scene","SCREEN_WIDTH","SCREEN_HEIGHT","VIEW_ANGLE","Number","ASPECT","NEAR","FAR","camera","PerspectiveCamera","add","position","set","ambient","AmbientLight","keyLight","DirectionalLight","Color","fillLight","backLight","normalize","iCol","background","WebGLRenderer","setPixelRatio","devicePixelRatio","setSize","setClearColor","domElement","controls","OrbitControls","enableDamping","dampingFactor","target","addEventListener","e","stopPropagation","code","lighting","intensity","remove","next"],"mappings":"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"}